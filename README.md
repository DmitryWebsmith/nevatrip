# Тестовое задание

## Задание 1

После успешной покупки билетов на событие, данные попадают в список заказов. Список заказов сохраняется в таблице MySql в виде:

| id | event_id | event_date          | ticket_adult_price | ticket_adult_quantity | ticket_kid_price | ticket_kid_quantity | barcode   | user_id | equal_price | created            |
|----|----------|---------------------|---------------------|-----------------------|------------------|---------------------|-----------|---------|-------------|---------------------|
| 1  | 003      | 2021-08-21 13:00:00 | 700                 | 1                     | 450              | 0                   | 11111111  | 00451   | 700         | 2021-01-11 13:22:09 |
| 2  | 006      | 2021-07-29 18:00:00 | 1000                | 0                     | 800              | 2                   | 22222222  | 00364   | 1600        | 2021-01-12 16:62:08 |
| 3  | 003      | 2021-08-15 17:00:00 | 700                 | 4                     | 450              | 3                   | 33333333  | 00015   | 4150        | 2021-01-13 10:08:45 |

Где:

- **id** - int(10) - инкрементальный порядковый номер заказа
- **event_id** - int(11) - уникальный ид события. У каждого события есть свое название, описание, расписание, цены и свой уникальный event_id соответственно
- **event_date** - varchar(10) - дата и время на которое были куплены билеты
- **ticket_adult_price** - int(11) - цена взрослого билета на момент покупки
- **ticket_adult_quantity** - int(11) - количество купленных взрослых билетов в этом заказе
- **ticket_kid_price** - int(11) - цена детского билета на момент покупки
- **ticket_kid_quantity** - int(11) - количество купленных детских билетов в этом заказе
- **barcode** - varchar(120) - уникальный штрих код заказа
- **equal_price** - int(11) - общая сумма заказа
- **created** - datetime - дата создания заказа

### Задача
Написать функцию, которая будет добавлять заказы в эту таблицу.

**Аргументы**, которые функция получает на входе: `event_id`, `event_date`, `ticket_adult_price`, `ticket_adult_quantity`, `ticket_kid_price`, `ticket_kid_quantity`

Нужно сгенерировать `barcode`, который будет уникальным со случайным набором цифр, он не должен быть порядковым.

Также, существует некая сторонняя [api.site.com](https://api.site.com). API писать не нужно, возвращаемые данные можно замокать и возвращать в случайном порядке, в которой нужно сделать бронь заказа, отправив ей `https://api.site.com/book` следующие параметры:

- `event_id`
- `event_date`
- `ticket_adult_price`
- `ticket_adult_quantity`
- `ticket_kid_price`
- `ticket_kid_quantity`
- `barcode`

На что она может вернуть либо `{message: 'order successfully booked'}`, либо `{error: 'barcode already exists'}`. В случае, если получаем ошибку, нужно сгенерировать новый `barcode` и повторить попытку. Важно учесть, если запрос будет происходить одновременно, не должно возникнуть такой ситуации, что двум разным заказам присвоился один номер.

После успешной брони нужно отправить на стороннюю API запрос с подтверждением `https://api.site.com/approve`, который принимает только `barcode`. Ответов может быть 2 варианта:

- Успешный: `{message: 'order successfully approved'}`
- Различные варианты ошибок: `{error: 'event cancelled'}`, `{error: 'no tickets'}`, `{error: 'no seats'}`, `{error: 'fan removed'}`.

В случае успеха, сохраняем заказ в БД.

Эта разметка позволит вам сохранить форматирование и структуру оригинального текста в Markdown.

## Решение задания №1. Локальная установка

1. Клонируйте репозиторий командой:
```bash
git clone https://github.com/DmitryWebsmith/nevatrip.git
```
2. Перейдите в директорию:
```bash
cd nevatrip
```
3. Выполните команды:
```bash
docker compose build app && \
docker compose up -d
```
4. Приложение доступно по адресу:
```bash
http://localhost/ 
```

## Задание №2.
- Некоторые события нужно продавать с дополнительными типами билетов - льготный и групповой, у которых будут свои цены и название. Имеется информация, что вероятно, будут другие типы билетов, которые нужно будет добавить. Нужно уметь сохранять при заказе 2 дополнительных типа билета, льготный и групповой в бд. Задача - Нормализовать таблицу учитывая добавленные типы билетов, показать конечный вид таблицы. Объяснить свое решение.
- Часто посетители из одного заказа приходят не одновременно на события. Возникает необходимость проверять их билеты по отдельности. Для этого у каждого билета должен быть свой баркод. Если в одном заказе было куплено несколько билетов, 2 взрослых, 3 детских, 4 льготных - то должно быть 9 баркодов для каждого билета соответственно. Задача - Нормализовать таблицу, учитывая что у каждого билета свой баркод, показать конечный вид таблицы. Объяснить свое решение.

## Решение задания №2

Формируем несколько таблиц, каждая из которых имеет свое уникальное назначение. 
В таблице "Заказы на событие" хранятся id пользователя, выполневшего заказ и номер общего заказа barcode_id.

### Таблица заказов на события

| id | event_id | barcode_id   | user_id | created             |
|----|----------|--------------|---------|---------------------|
| 1  | 003      | 11111111     | 00451   | 2021-01-11 13:22:09 |
| 2  | 006      | 22222222     | 00364   | 2021-01-12 16:62:08 |
| 3  | 003      | 33333333     | 00015   | 2021-01-13 10:08:45 |

Где:

- **barcode_id** - номер общего заказа

Таблица событий хранит данные событий, описание и дату.

### Таблица событий

| id | event_date          | description         |
|----|---------------------|---------------------|
| 1  | 2021-08-21 13:00:00 | descritrion_1       |
| 2  | 2021-07-29 18:00:00 | descritrion_2       |
| 3  | 2021-08-15 17:00:00 | descritrion_3       |


В таблице билетов сведены данные о номере общего заказа, номер билетов, принадлежащих к общим заказам и типы этих билетов.

### Таблица билетов

| id | barcode_id   | tiket_barcode_id | tiket_type_id       | status |
|----|-----------   |------------------|---------------------|--------|
| 1  | 11111111     | 00451            | 1		     | 0      |
| 2  | 22222222     | 00364            | 2		     | 1      |
| 3  | 33333333     | 00015            | 1		     | 0      |

Где:

- **barcode_id** - номер общего заказа
- **tiket_barcode_id** - номер билета
- **tiket_type_id** - тип билета
- **status** - стату билета (использован, не использован, просрочен)

И соответственно таблица типов билетов, где приведены данные имени типа и стоимости такого билета.

### Таблица типов билетов

| id | name         | cost    |
|----|-----------   |---------|
| 1  | adult        | 1000    |
| 2  | kid          | 500     |
| 3  | preferential | 1500    |

Где:

- **name** - наименование билета
- **cost** - цена билета

## Задание №3.

Сопроводить документацией своё решение.

## Решение задания №3.

Данный README.md

